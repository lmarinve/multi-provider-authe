<!DOCTYPE html>
<html>
<head>
    <title>PKCE Debug Tool - CILogon</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        button:hover {
            background: #0056b3;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .step h3 {
            margin-top: 0;
            color: #495057;
        }
        .success {
            border-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CILogon PKCE Debug Tool</h1>
        <p>This tool helps debug PKCE issues by showing exact values at each step.</p>

        <div class="step">
            <h3>Step 1: Generate PKCE Values</h3>
            <button onclick="generatePKCE()">Generate New PKCE Values</button>
            <button onclick="loadStoredPKCE()">Load Stored Values</button>
            <div id="pkce-output" class="output"></div>
        </div>

        <div class="step">
            <h3>Step 2: Test Challenge Generation</h3>
            <label>Code Verifier:</label>
            <input id="verifier-input" type="text" placeholder="Paste verifier here">
            <br><br>
            <button onclick="testChallenge()">Generate Challenge</button>
            <div id="challenge-output" class="output"></div>
        </div>

        <div class="step">
            <h3>Step 3: Create Auth URL</h3>
            <button onclick="createAuthUrl()">Create CILogon Auth URL</button>
            <div id="auth-output" class="output"></div>
        </div>

        <div class="step">
            <h3>Step 4: Test Token Exchange</h3>
            <label>Authorization Code:</label>
            <input id="code-input" type="text" placeholder="Paste code from callback">
            <label>State:</label>
            <input id="state-input" type="text" placeholder="Paste state from callback">
            <br><br>
            <button onclick="testTokenExchange()">Test Token Exchange</button>
            <div id="token-output" class="output"></div>
        </div>

        <div class="step">
            <h3>Current Storage State</h3>
            <button onclick="showStorage()">Show Current Storage</button>
            <button onclick="clearStorage()">Clear All Storage</button>
            <div id="storage-output" class="output"></div>
        </div>
    </div>

    <script>
        let currentVerifier = '';
        let currentChallenge = '';
        let currentState = '';

        function log(containerId, message, clear = false) {
            const container = document.getElementById(containerId);
            if (clear) {
                container.textContent = '';
            }
            container.textContent += message + '\n';
        }

        async function generatePKCE() {
            log('pkce-output', 'Generating PKCE values...', true);
            
            try {
                // Generate state
                const stateArray = new Uint8Array(32);
                crypto.getRandomValues(stateArray);
                currentState = btoa(String.fromCharCode(...stateArray))
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=+/g, "");

                // Generate code verifier - using 64 bytes for extra entropy
                const verifierArray = new Uint8Array(64);
                crypto.getRandomValues(verifierArray);
                currentVerifier = btoa(String.fromCharCode(...verifierArray))
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=+/g, "");
                
                log('pkce-output', `Generated State: ${currentState}`);
                log('pkce-output', `Generated Verifier: ${currentVerifier}`);
                log('pkce-output', `Verifier Length: ${currentVerifier.length}`);
                log('pkce-output', `Valid RFC7636 chars: ${/^[A-Za-z0-9\-._~]{43,128}$/.test(currentVerifier)}`);
                
                // Generate code challenge
                const encoder = new TextEncoder();
                const data = encoder.encode(currentVerifier);
                const digest = await crypto.subtle.digest('SHA-256', data);
                currentChallenge = btoa(String.fromCharCode(...new Uint8Array(digest)))
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=+/g, "");
                
                log('pkce-output', `Generated Challenge: ${currentChallenge}`);
                log('pkce-output', `Challenge Length: ${currentChallenge.length}`);
                
                // Store values
                const pkceData = { [currentState]: currentVerifier };
                sessionStorage.setItem('pkce', JSON.stringify(pkceData));
                localStorage.setItem(`pkce_${currentState}`, currentVerifier);
                sessionStorage.setItem('cilogon_state', currentState);
                sessionStorage.setItem('cilogon_code_verifier', currentVerifier);
                
                log('pkce-output', '\n✅ Values generated and stored successfully');
                
                // Update inputs
                document.getElementById('verifier-input').value = currentVerifier;
                document.getElementById('state-input').value = currentState;
                
            } catch (error) {
                log('pkce-output', `❌ Error: ${error.message}`);
            }
        }

        function loadStoredPKCE() {
            log('pkce-output', 'Loading stored PKCE values...', true);
            
            try {
                // Try to load from various storage methods
                const pkceMap = JSON.parse(sessionStorage.getItem('pkce') || '{}');
                const storedState = sessionStorage.getItem('cilogon_state');
                const storedVerifier = sessionStorage.getItem('cilogon_code_verifier');
                
                log('pkce-output', `PKCE Map: ${JSON.stringify(pkceMap)}`);
                log('pkce-output', `Direct State: ${storedState}`);
                log('pkce-output', `Direct Verifier: ${storedVerifier ? storedVerifier.substring(0, 20) + '...' : 'null'}`);
                
                if (storedState && storedVerifier) {
                    currentState = storedState;
                    currentVerifier = storedVerifier;
                    document.getElementById('verifier-input').value = currentVerifier;
                    document.getElementById('state-input').value = currentState;
                    log('pkce-output', '\n✅ Loaded from direct storage');
                } else if (Object.keys(pkceMap).length > 0) {
                    const firstState = Object.keys(pkceMap)[0];
                    currentState = firstState;
                    currentVerifier = pkceMap[firstState];
                    document.getElementById('verifier-input').value = currentVerifier;
                    document.getElementById('state-input').value = currentState;
                    log('pkce-output', '\n✅ Loaded from state-based storage');
                } else {
                    log('pkce-output', '\n❌ No stored values found');
                }
                
            } catch (error) {
                log('pkce-output', `❌ Error: ${error.message}`);
            }
        }

        async function testChallenge() {
            const verifier = document.getElementById('verifier-input').value.trim();
            if (!verifier) {
                log('challenge-output', '❌ Please enter a code verifier', true);
                return;
            }

            log('challenge-output', 'Testing challenge generation...', true);
            log('challenge-output', `Input Verifier: ${verifier}`);
            log('challenge-output', `Verifier Length: ${verifier.length}`);
            log('challenge-output', `Valid Format: ${/^[A-Za-z0-9\-._~]{43,128}$/.test(verifier)}`);

            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(verifier);
                log('challenge-output', `UTF-8 bytes length: ${data.length}`);
                
                const digest = await crypto.subtle.digest('SHA-256', data);
                const challenge = btoa(String.fromCharCode(...new Uint8Array(digest)))
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=+/g, "");
                
                log('challenge-output', `Generated Challenge: ${challenge}`);
                log('challenge-output', `Challenge Length: ${challenge.length}`);
                
                currentChallenge = challenge;
                currentVerifier = verifier;
                
                log('challenge-output', '\n✅ Challenge generated successfully');
                
            } catch (error) {
                log('challenge-output', `❌ Error: ${error.message}`);
            }
        }

        function createAuthUrl() {
            if (!currentChallenge || !currentVerifier) {
                log('auth-output', '❌ Please generate PKCE values first', true);
                return;
            }

            log('auth-output', 'Creating CILogon auth URL...', true);

            const authParams = new URLSearchParams({
                response_type: 'code',
                client_id: 'cilogon:/client_id/e33e29a20f84e0edd144d1e9a6e2b0',
                redirect_uri: 'https://lmarinve.github.io/multi-provider-authe/auth/callback/cilogon',
                scope: 'openid',
                state: currentState,
                code_challenge: currentChallenge,
                code_challenge_method: 'S256'
            });

            const authUrl = `https://cilogon.org/authorize?${authParams.toString()}`;
            
            log('auth-output', 'Auth URL Parameters:');
            log('auth-output', `  client_id: cilogon:/client_id/e33e29a20f84e0edd144d1e9a6e2b0`);
            log('auth-output', `  redirect_uri: https://lmarinve.github.io/multi-provider-authe/auth/callback/cilogon`);
            log('auth-output', `  scope: openid`);
            log('auth-output', `  state: ${currentState}`);
            log('auth-output', `  code_challenge: ${currentChallenge}`);
            log('auth-output', `  code_challenge_method: S256`);
            log('auth-output', `\nFull URL:\n${authUrl}`);
            
            // Create clickable link
            const container = document.getElementById('auth-output');
            const link = document.createElement('a');
            link.href = authUrl;
            link.target = '_blank';
            link.textContent = '\n🔗 Click here to test authentication';
            link.style.display = 'block';
            link.style.marginTop = '10px';
            link.style.color = '#007bff';
            container.appendChild(link);
        }

        async function testTokenExchange() {
            const code = document.getElementById('code-input').value.trim();
            const state = document.getElementById('state-input').value.trim();
            
            if (!code || !state) {
                log('token-output', '❌ Please enter both code and state', true);
                return;
            }

            log('token-output', 'Testing token exchange...', true);
            
            // Find the verifier for this state
            let verifier = null;
            const pkceMap = JSON.parse(sessionStorage.getItem('pkce') || '{}');
            verifier = pkceMap[state];
            
            if (!verifier) {
                verifier = localStorage.getItem(`pkce_${state}`);
            }
            
            if (!verifier && state === sessionStorage.getItem('cilogon_state')) {
                verifier = sessionStorage.getItem('cilogon_code_verifier');
            }
            
            if (!verifier) {
                log('token-output', `❌ No verifier found for state: ${state}`);
                return;
            }
            
            log('token-output', `Found verifier for state: ${verifier.substring(0, 20)}...`);
            log('token-output', `Verifier length: ${verifier.length}`);
            log('token-output', `Verifier valid: ${/^[A-Za-z0-9\-._~]{43,128}$/.test(verifier)}`);
            
            // Prepare token request
            const tokenParams = new URLSearchParams();
            tokenParams.append('grant_type', 'authorization_code');
            tokenParams.append('code', code);
            tokenParams.append('client_id', 'cilogon:/client_id/e33e29a20f84e0edd144d1e9a6e2b0');
            tokenParams.append('redirect_uri', 'https://lmarinve.github.io/multi-provider-authe/auth/callback/cilogon');
            tokenParams.append('code_verifier', verifier);
            
            log('token-output', '\nToken request parameters:');
            log('token-output', `  grant_type: authorization_code`);
            log('token-output', `  code: ${code.substring(0, 20)}...`);
            log('token-output', `  client_id: cilogon:/client_id/e33e29a20f84e0edd144d1e9a6e2b0`);
            log('token-output', `  redirect_uri: https://lmarinve.github.io/multi-provider-authe/auth/callback/cilogon`);
            log('token-output', `  code_verifier: ${verifier.substring(0, 20)}...`);
            
            try {
                log('token-output', '\nSending request to: https://cilogon.org/oauth2/token');
                
                const response = await fetch('https://cilogon.org/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: tokenParams.toString()
                });

                log('token-output', `Response status: ${response.status} ${response.statusText}`);
                
                const responseText = await response.text();
                log('token-output', `Response body: ${responseText}`);
                
                if (response.ok) {
                    const tokenData = JSON.parse(responseText);
                    log('token-output', '\n✅ Token exchange successful!');
                    log('token-output', `Token type: ${tokenData.token_type || 'Bearer'}`);
                    log('token-output', `Has ID token: ${!!tokenData.id_token}`);
                    log('token-output', `Has access token: ${!!tokenData.access_token}`);
                    log('token-output', `Expires in: ${tokenData.expires_in || 'unknown'} seconds`);
                } else {
                    log('token-output', '\n❌ Token exchange failed');
                    try {
                        const errorData = JSON.parse(responseText);
                        log('token-output', `Error: ${errorData.error || 'Unknown'}`);
                        log('token-output', `Description: ${errorData.error_description || 'No description'}`);
                    } catch (e) {
                        log('token-output', `Raw error: ${responseText}`);
                    }
                }
                
            } catch (error) {
                log('token-output', `❌ Network error: ${error.message}`);
            }
        }

        function showStorage() {
            log('storage-output', 'Current storage state:', true);
            
            // SessionStorage
            log('storage-output', '\nSessionStorage:');
            log('storage-output', `  pkce: ${sessionStorage.getItem('pkce') || 'null'}`);
            log('storage-output', `  cilogon_state: ${sessionStorage.getItem('cilogon_state') || 'null'}`);
            const verifier = sessionStorage.getItem('cilogon_code_verifier');
            log('storage-output', `  cilogon_code_verifier: ${verifier ? verifier.substring(0, 20) + '...' : 'null'}`);
            
            // LocalStorage
            log('storage-output', '\nLocalStorage (pkce_* keys):');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('pkce_')) {
                    const value = localStorage.getItem(key);
                    log('storage-output', `  ${key}: ${value ? value.substring(0, 20) + '...' : 'null'}`);
                }
            }
        }

        function clearStorage() {
            // Clear sessionStorage
            sessionStorage.removeItem('pkce');
            sessionStorage.removeItem('cilogon_state');
            sessionStorage.removeItem('cilogon_code_verifier');
            
            // Clear localStorage pkce_* keys
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('pkce_')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            log('storage-output', '✅ All PKCE storage cleared', true);
            
            // Clear form inputs
            document.getElementById('verifier-input').value = '';
            document.getElementById('state-input').value = '';
            document.getElementById('code-input').value = '';
            
            // Reset variables
            currentVerifier = '';
            currentChallenge = '';
            currentState = '';
        }

        // Initialize
        window.addEventListener('load', () => {
            showStorage();
        });
    </script>
</body>
</html>